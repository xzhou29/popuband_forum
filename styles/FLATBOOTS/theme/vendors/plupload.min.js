plupload.addI18n(phpbb.plupload.i18n),phpbb.plupload.ids=[],function(p){"use strict";phpbb.plupload.initialize=function(){phpbb.plupload.uploader.init(),phpbb.plupload.setData(phpbb.plupload.data),phpbb.plupload.updateMultipartParams(phpbb.plupload.getSerializedData()),phpbb.plupload.uploader.bind("Init",function(){phpbb.plupload.form=p(phpbb.plupload.config.form_hook)[0],phpbb.plupload.rowTpl=p("#attach-row-tpl")[0].outerHTML,p("#attach-row-tpl, #attach-panel-basic").remove(),p("#attach-panel-multi").show()}),phpbb.plupload.uploader.bind("PostInit",function(){phpbb.plupload.uploader.features.dragdrop&&p("#drag-n-drop-message").show(),p("#attach-panel-multi").is(":visible")&&phpbb.plupload.uploader.refresh(),p("#posting-attach-body-html").one("click",function(){phpbb.plupload.uploader.refresh()})})},phpbb.plupload.clearParams=function(){var p=phpbb.plupload.uploader.settings.multipart_params;for(var a in p)p.hasOwnProperty(a)&&0===a.indexOf("attachment_data[")&&delete phpbb.plupload.uploader.settings.multipart_params[a]},phpbb.plupload.updateMultipartParams=function(a){var e=phpbb.plupload.uploader.settings;e.multipart_params=p.extend(e.multipart_params,a)},phpbb.plupload.getSerializedData=function(){for(var p={},a=0;a<phpbb.plupload.data.length;a++){var e=phpbb.plupload.data[a];for(var l in e)e.hasOwnProperty(l)&&(p["attachment_data["+a+"]["+l+"]"]=e[l])}return p},phpbb.plupload.getIndex=function(a){var e=p.inArray(Number(a),phpbb.plupload.ids);return-1!==e?e:!1},phpbb.plupload.setData=function(p){phpbb.plupload.ids=phpbb.plupload.data=[],phpbb.plupload.data=p;for(var a=0;a<p.length;a++)phpbb.plupload.ids.push(Number(p[a].attach_id))},phpbb.plupload.update=function(p,a,e,l){phpbb.plupload.updateBbcode(a,e),phpbb.plupload.setData(p),phpbb.plupload.updateRows(l),phpbb.plupload.clearParams(),phpbb.plupload.updateMultipartParams(phpbb.plupload.getSerializedData())},phpbb.plupload.updateRows=function(p){for(var a=0;a<phpbb.plupload.ids.length;a++)phpbb.plupload.updateRow(a,p)},phpbb.plupload.insertRow=function(a){var e=p(phpbb.plupload.rowTpl);e.attr("id",a.id),e.find(".file-name").html(plupload.xmlEncode(a.name)),e.find(".file-size").html(plupload.formatSize(a.size)),"desc"===phpbb.plupload.order?p("#file-list").prepend(e):p("#file-list").append(e)},phpbb.plupload.updateRow=function(a,e){var l=phpbb.plupload.data[a],t=p('[data-attach-id="'+l.attach_id+'"]');if("undefined"!=typeof e&&"undefined"!=typeof e[a]){var d=e[a].replace("&amp;","&"),o=p("<a></a>");o.attr("href",d).html(l.real_filename),t.find(".file-name").html(o)}t.find("textarea").attr("name","comment_list["+a+"]"),phpbb.plupload.updateHiddenData(t,l,a)},phpbb.plupload.updateHiddenData=function(a,e,l){a.find('input[type="hidden"]').remove();for(var t in e){if(!e.hasOwnProperty(t))return;var d=p("<input />").attr("type","hidden").attr("name","attachment_data["+l+"]["+t+"]").attr("value",e[t]);p("textarea",a).after(d)}},phpbb.plupload.deleteFile=function(a,e){if("undefined"==typeof e){var l=phpbb.plupload.uploader.getFile(a.attr("id"));phpbb.plupload.uploader.removeFile(l),a.slideUp(100,function(){a.remove(),phpbb.plupload.hideEmptyList()})}var t=phpbb.plupload.getIndex(e);if(a.find(".file-status").toggleClass("file-uploaded file-working"),t!==!1){var d={};d["delete_file["+t+"]"]=1;var o=function(){a.find(".file-status").removeClass("file-working")},r=function(p){if("object"==typeof p){if("undefined"!=typeof p.title)return phpbb.plupload.uploader.trigger("Error",{message:p.message}),void a.find(".file-status").toggleClass("file-uploaded");if(phpbb.plupload.update(p,"removal",t),phpbb.plupload.handleMaxFilesReached(),a.attr("id")){var e=phpbb.plupload.uploader.getFile(a.attr("id"));phpbb.plupload.uploader.removeFile(e)}a.slideUp(100,function(){a.remove(),phpbb.plupload.hideEmptyList()}),phpbb.plupload.uploader.trigger("FilesRemoved")}};p.ajax(phpbb.plupload.config.url,{type:"POST",data:p.extend(d,phpbb.plupload.getSerializedData()),headers:phpbb.plupload.config.headers}).always(o).done(r)}},phpbb.plupload.hideEmptyList=function(){p("#file-list").children().length||p("#file-list-container").slideUp(100)},phpbb.plupload.updateBbcode=function(a,e){function l(p){var a=new RegExp("\\[attachment="+p+"\\](.*?)\\[\\/attachment\\]","g");d=d.replace(a,function(a,l){if(o&&e===p)return"";var t=p+(o?-1:1);return"[attachment="+t+"]"+l+"[/attachment]"})}var t=p("#message",phpbb.plupload.form),d=t.val(),o="removal"===a;if(-1!==d.indexOf("[attachment=")){var r;if(o)for(r=e;r<phpbb.plupload.ids.length;r++)l(r);else for(r=phpbb.plupload.ids.length-1;r>=e;r--)l(r);t.val(d)}},phpbb.plupload.getFilesByStatus=function(a){var e=[];return p.each(phpbb.plupload.uploader.files,function(p,l){l.status===a&&e.push(l)}),e},phpbb.plupload.handleMaxFilesReached=function(){return phpbb.plupload.maxFiles?phpbb.plupload.maxFiles<=phpbb.plupload.ids.length?(phpbb.plupload.markQueuedFailed(phpbb.plupload.lang.TOO_MANY_ATTACHMENTS),phpbb.plupload.disableUploader(),phpbb.plupload.uploader.trigger("Error",{message:phpbb.plupload.lang.TOO_MANY_ATTACHMENTS}),!0):(phpbb.plupload.maxFiles>phpbb.plupload.ids.length&&phpbb.plupload.enableUploader(),!1):!1},phpbb.plupload.disableUploader=function(){p("#add_files").addClass("disabled"),phpbb.plupload.uploader.disableBrowse()},phpbb.plupload.enableUploader=function(){p("#add_files").removeClass("disabled"),phpbb.plupload.uploader.disableBrowse(!1)},phpbb.plupload.markQueuedFailed=function(a){var e=phpbb.plupload.getFilesByStatus(plupload.QUEUED);p.each(e,function(e,l){p("#"+l.id).find(".file-progress").hide(),phpbb.plupload.fileError(l,a)})},phpbb.plupload.fileError=function(a,e){a.status=plupload.FAILED,a.error=e,p("#"+a.id).find(".file-status").addClass("file-error").attr({"data-error-title":phpbb.plupload.lang.ERROR,"data-error-message":e})},phpbb.plupload.uploader=new plupload.Uploader(phpbb.plupload.config),phpbb.plupload.initialize();var a=p("#file-list");a.on("click",".file-inline-bbcode",function(a){var e=p(this).parents(".attach-row").attr("data-attach-id"),l=phpbb.plupload.getIndex(e);attachInline(l,phpbb.plupload.data[l].real_filename),a.preventDefault()}),a.on("click",".file-delete",function(a){var e=p(this).parents(".attach-row"),l=e.attr("data-attach-id");phpbb.plupload.deleteFile(e,l),a.preventDefault()}),a.on("click",".file-error",function(a){phpbb.alert(p(this).attr("data-error-title"),p(this).attr("data-error-message")),a.preventDefault()}),phpbb.plupload.uploader.bind("Error",function(p,a){a.file.name=plupload.xmlEncode(a.file.name),a.code===plupload.FILE_EXTENSION_ERROR?a.message=plupload.translate("Invalid file extension:")+" "+a.file.name:a.code===plupload.FILE_SIZE_ERROR&&(a.message=plupload.translate("File too large:")+" "+a.file.name),phpbb.alert(phpbb.plupload.lang.ERROR,a.message)}),phpbb.plupload.uploader.bind("BeforeUpload",function(a,e){phpbb.plupload.handleMaxFilesReached()||phpbb.plupload.updateMultipartParams({real_filename:e.name,add_bbwatermark:p("#add_bbwatermark").is(":checked"),bbwatermark_pos:p("#bbwatermark_pos").val()})}),phpbb.plupload.uploader.bind("ChunkUploaded",function(a,e,l){if(!(l.chunk>=l.chunks-1)){var t={};try{t=p.parseJSON(l.response)}catch(d){e.status=plupload.FAILED,a.trigger("FileUploaded",e,{response:JSON.stringify({error:{message:"Error parsing server response."}})})}"undefined"!=typeof t.title&&(t.error={message:t.message}),t.error&&(e.status=plupload.FAILED,a.trigger("FileUploaded",e,{response:JSON.stringify({error:{message:t.error.message}})}))}}),phpbb.plupload.uploader.bind("FilesAdded",function(a,e){if(!phpbb.plupload.handleMaxFilesReached()){"function"==typeof activateSubPanel&&activateSubPanel("attach-panel");var l=p("#file-list-container");l.is(":visible")||l.show(100),p.each(e,function(p,a){phpbb.plupload.insertRow(a)}),a.bind("UploadProgress",function(a,e){p(".file-progress-bar","#"+e.id).css("width",e.percent+"%"),p(".file-progress-bar").html(a.total.percent+"%")}),phpbb.plupload.disableUploader(),a.start()}}),phpbb.plupload.uploader.bind("FileUploaded",function(a,e,l){var t,d={},o=p("#"+e.id);o.find(".file-progress").fadeOut(3e3);try{d=JSON.parse(l.response)}catch(r){t="Error parsing server response."}"undefined"!=typeof d.title?(t=d.message,a.trigger("Error",{message:t}),phpbb.plupload.markQueuedFailed(t)):d.error&&(t=d.error.message),"undefined"!=typeof t?phpbb.plupload.fileError(e,t):e.status===plupload.DONE&&(e.attachment_data=d.data[0],o.attr("data-attach-id",e.attachment_data.attach_id),o.find(".file-inline-bbcode").show(),o.find(".file-status").addClass("file-uploaded"),phpbb.plupload.update(d.data,"addition",0,[d.download_url]))}),phpbb.plupload.uploader.bind("UploadComplete",function(){setTimeout(function(){p("#file-total-progress-bar").fadeOut(500,function(){p(this).css("width",0).show()})},2e3),phpbb.plupload.enableUploader()})}(jQuery);